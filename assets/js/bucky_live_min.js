(function(){var E,n,K,P,x,X,H,I=[].slice;(x="undefined"!=typeof module&&null!==module&&!("undefined"!=typeof window&&null!==window?window.module:void 0))?(E=require("xmlhttprequest").XMLHttpRequest,H=function(){var n;return 1e3*((n=process.hrtime())[0]+n[1]/1e9)}):H=function(){var n,e;return null!=(n=null!=(e=window.performance)&&"function"==typeof e.now?e.now():void 0)?n:+new Date},P=+new Date,K=function(){var n,e,t,r,o,u,i;for(n=arguments[0],u=0,i=(r=2<=arguments.length?I.call(arguments,1):[]).length;u<i;u++)for(e in t=r[u])o=t[e],n[e]=o;return n},(X=function(){var n,e;if(n=1<=arguments.length?I.call(arguments,0):[],null!=("undefined"!=typeof console&&null!==console&&null!=(e=console.log)?e.call:void 0))return console.log.apply(console,n)}).error=function(){var n,e;if(n=1<=arguments.length?I.call(arguments,0):[],null!=("undefined"!=typeof console&&null!==console&&null!=(e=console.error)?e.call:void 0))return console.error.apply(console,n)},n=function(){var n,u,o,i,e,l,t,c,m,w,r,g,a,d,y,s,f,p,v,h,S,b,T,q,k,L,M,R;if(t={host:"/bucky",maxInterval:3e4,aggregationInterval:5e3,decimalPrecision:3,sendLatency:!1,sample:1,active:!0},S={},!x&&(n="function"==typeof document.querySelector?document.querySelector("[data-bucky-host],[data-bucky-page],[data-bucky-requests]"):void 0))for(S={host:n.getAttribute("data-bucky-host"),pagePerformanceKey:n.getAttribute("data-bucky-page"),requestsKey:n.getAttribute("data-bucky-requests")},q=0,k=(L=["pagePerformanceKey","requestsKey"]).length;q<k;q++)"true"===(null!=(M=S[w=L[q]])?M.toString().toLowerCase():void 0)||""===S[w]?S[w]=!0:"false"===(null!=(R=S[w])?R.toString().toLowerCase():void 0)&&(S[w]=null);return y=K({},t,S),i={timer:"ms",gauge:"g",counter:"c"},u=y.active,(b=function(){return u=y.active&&Math.random()<y.sample})(),o=[],h=function(n){return K(y,n),("sample"in n||"active"in n)&&b(),y},f=function(n,e){return null==e&&(e=y.decimalPrecision),Math.round(n*Math.pow(10,e))/Math.pow(10,e)},s={},c=function(n,e,t){var r,o;if(u)return r=1,n in s&&("counter"===t?e+=s[n].value:(r=null!=(o=s[n].count)?o:r,r++,e=s[n].value+(e-s[n].value)/r)),s[n]={value:e,type:t,count:r},l()},d=v=null,m=function(){return clearTimeout(v),clearTimeout(d),v=d=null,p()},l=function(){if(clearTimeout(v),v=setTimeout(m,y.aggregationInterval),null==d)return d=setTimeout(m,y.maxInterval)},a=function(n){var e,t,r,o,u,i,l,a;for(o in t=x||window.XMLHttpRequest&&(window.XMLHttpRequest.defake||"withCredentials"in new window.XMLHttpRequest),i=!!x||(!(r=/^(https?:\/\/[^\/]+)/i.exec(y.host))||r[1]===document.location.protocol+"//"+document.location.host),l=H(),e="",n)e+=o+":"+n[o]+"\n";return(u=i||t||null==("undefined"!=typeof window&&null!==window?window.XDomainRequest:void 0)?new(null!=(a="undefined"!=typeof window&&null!==window?window.XMLHttpRequest:void 0)?a:E):new window.XDomainRequest).bucky={track:!1},"http:"==document.location.protocol?u.open("POST","http://speed.sginfra.net/v1/send",!0):"https:"==document.location.protocol&&u.open("POST","https://speed.sginfra.net/v1/send",!0),u.setRequestHeader("Content-Type","text/plain"),u.addEventListener("load",function(){return T(H()-l)},!1),u.send(e),u},r=!(p=function(){var n,e,t,r;if(u){for(w in n={},s)e=s[w],o.push({path:w,count:e.count,type:e.type,value:e.value}),null!=i[e.type]?(t=e.value,"gauge"!==(r=e.type)&&"timer"!==r||(t=f(t)),n[w]=t+"|"+i[e.type],1!==e.count&&(n[w]+="@"+f(1/e.count,5))):X.error("Type "+e.type+" not understood by Bucky");return a(n),s={}}X("Would send bucky queue")}),T=function(n){if(y.sendLatency&&!r)return c("bucky.latency",n,"timer"),r=!0,setTimeout(function(){return r=!1},3e5)},e=(g=function(t){var r,d,n,e,p,s,l,a,f;for(w in null==t&&(t=""),r=function(n){return(null!=t?t.length:void 0)?t+"."+n:n},f={TIMES:{},send:function(n,e){return s(n,e,"timer")},time:function(){var n,e,t,r,o;return o=arguments[0],n=arguments[1],t=arguments[2],e=4<=arguments.length?I.call(arguments,3):[],f.start(o),r=function(){return f.stop(o)},e.splice(0,0,r),n.apply(t,e)},timeSync:function(){var n,e,t,r,o;return r=arguments[0],n=arguments[1],t=arguments[2],e=4<=arguments.length?I.call(arguments,3):[],f.start(r),o=n.apply(t,e),f.stop(r),o},wrap:function(t,e){return null!=e?function(){var n;return n=1<=arguments.length?I.call(arguments,0):[],f.timeSync.apply(f,[t,e,this].concat(I.call(n)))}:function(e){return function(){var n;return n=1<=arguments.length?I.call(arguments,0):[],f.timeSync.apply(f,[t,e,this].concat(I.call(n)))}}},start:function(n){return f.TIMES[n]=H()},stop:function(n){var e;if(null!=f.TIMES[n])return e=H()-f.TIMES[n],f.TIMES[n]=void 0,f.send(n,e);X.error("Timer "+n+" ended without having been started")},stopwatch:function(r,o){var u,i;return null!=o?i=function(){return+new Date}:o=(i=H)(),u=o,{mark:function(n,e){var t;return null==e&&(e=0),t=i(),r&&(n=r+"."+n),f.send(n,t-o+e)},split:function(n,e){var t;return null==e&&(e=0),t=i(),r&&(n=r+"."+n),f.send(n,t-u+e),u=t}}},mark:function(n,e){var t;return null==e&&(e=+new Date),t=f.navigationStart(),f.send(n,e-t)},navigationStart:function(){var n,e,t;return null!=(n="undefined"!=typeof window&&null!==window&&null!=(e=window.performance)&&null!=(t=e.timing)?t.navigationStart:void 0)?n:P},responseEnd:function(){var n,e,t;return null!=(n="undefined"!=typeof window&&null!==window&&null!=(e=window.performance)&&null!=(t=e.timing)?t.responseEnd:void 0)?n:P},now:function(){return H()}},a=!(d=function(n,e){return null==e&&(e=1),s(n,e,"counter")}),l=function(n){var e,t,r,o,u,i=this;if(null==("undefined"!=typeof window&&null!==window&&null!=(r=window.performance)?r.timing:void 0))return!1;if(a)return!1;if(n&&!0!==n||(n=p.urlToKey(document.location.toString())+".page"),"uninitialized"===(o=document.readyState)||"loading"===o)return"function"==typeof window.addEventListener&&window.addEventListener("load",function(){return setTimeout(function(){return l.call(i,n)},500)},!1),!1;for(w in a=!0,e=window.performance.timing.navigationStart,u=window.performance.timing)"number"==typeof(t=u[w])&&f.send(n+"."+w,t-e);return!0},p={transforms:{mapping:{guid:/\/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi,sha1:/\/[0-9a-f]{40}/gi,md5:/\/[0-9a-f]{32}/gi,id:/\/[0-9;_\-]+/g,email:/\/[^/]+@[^/]+/g,domain:[/\/[^/]+\.[a-z]{2,3}\//gi,"/"]},enabled:["guid","sha1","md5","id","email","domain"],enable:function(n,e,t){return null==t&&(t=""),null!=e&&(this.mapping[n]=[e,t]),this.enabled.splice(0,0,n)},disable:function(n){var e,t;for(e in t=this.enabled)if(t[e]===n)return void this.enabled.splice(e,1)}},sendReadyStateTimes:function(n,e){var t,r,o,u,i,l,a,c;if(null!=e){for(t in r={1:"sending",2:"headers",3:"waiting",4:"receiving"},o={},u=null,e)l=e[t],null!=u&&null!=r[t]&&(o[r[t]]=l-u),u=l;for(i in c=[],o)a=o[i],c.push(f.send(n+"."+i,a));return c}},urlToKey:function(n,e,t){var r,o,u,i,l,a,c,d,s,f;for(n=n.replace(/https?:\/\//i,""),r=(i=/([^/:]*)(?::\d+)?(\/[^\?#]*)?.*/i.exec(n))[1],l=null!=(s=i[2])?s:"",c=0,d=(f=p.transforms.enabled).length;c<d;c++)u=f[c],null!=(o=p.transforms.mapping[u])?"function"!=typeof o?(o instanceof RegExp&&(o=[o,""]),l=l.replace(o[0],o[1])):l=o(l,n,e,t):X.error("Bucky Error: Attempted to enable a mapping which is not defined: "+u);return a=(a=(a=(a=r+(l=(l=decodeURIComponent(l)).replace(/[^a-zA-Z0-9\-\.\/ ]+/g,"_")).replace(/[\/ ]/g,".")).replace(/(^\.)|(\.$)/g,"")).replace(/\.com/,"")).replace(/www\./,""),t&&(a=t+"."+a),e&&(a=a+"."+e.toLowerCase()),a=a.replace(/\.\./g,".")},getFullUrl:function(n,e){return null==e&&(e=document.location),/^\//.test(n)?e.hostname+n:/https?:\/\//i.test(n)?n:e.toString()+n},monitor:function(a){var l,c,e;return a&&!0!==a||(a=p.urlToKey(document.location.toString())+".requests"),c=this,l=function(n){var e,t,r,o,u,i,l;if(i=n.type,l=n.url,n.event,r=n.request,t=n.readyStateTimes,null!=(o=n.startTime))return e=H()-o,l=c.getFullUrl(l),u=c.urlToKey(l,i,a),s(u,e,"timer"),c.sendReadyStateTimes(u,t),null!=(null!=r?r.status:void 0)?(12e3<r.status?d(u+".0"):0!==r.status&&d(u+"."+r.status.toString().charAt(0)+"xx"),d(u+"."+r.status)):void 0},e=window.XMLHttpRequest,window.XMLHttpRequest=function(){var r,o,u,i,n;o=new e;try{u=null,r={},i=o.open,o.open=function(e,t,n){try{r[0]=H(),o.addEventListener("readystatechange",function(){return r[o.readyState]=H()},!1),o.addEventListener("loadend",function(n){if(null==o.bucky||!1!==o.bucky.track)return l({type:e,url:t,event:n,startTime:u,readyStateTimes:r,request:o})},!1)}catch(n){X.error("Bucky error monitoring XHR open call",n)}return i.apply(o,arguments)},n=o.send,o.send=function(){return u=H(),n.apply(o,arguments)}}catch(n){X.error("Bucky error monitoring XHR",n)}return o}}},e=function(n){var e;return null==n&&(n=""),(e=null!=t?t:"")&&n&&(e+="."),n&&(e+=n),g(e)},n={send:s=function(n,e,t){if(null==t&&(t="gauge"),null!=e&&null!=n)return c(r(n),e,t);X.error("Can't log "+n+":"+e)},count:d,timer:f,now:H,requests:p,sendPagePerformance:l,flush:m,setOptions:h,options:y,history:o,active:u})e[w]=n[w];return e})(),y.pagePerformanceKey&&e.sendPagePerformance(y.pagePerformanceKey),y.requestsKey&&e.requests.monitor(y.requestsKey),e},"function"==typeof define&&define.amd?define(n):"object"==typeof exports?module.exports=n():window.Bucky=n()}).call(this);